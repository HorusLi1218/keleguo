<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¯æ¨‚æœå¯µç‰©ç”Ÿæ´»é¤¨ | å®šå‹åŒ–å¥‘ç´„ç°½ç½²ç³»çµ±</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        .animate-pulse-slow { animation: pulse-slow 2s infinite; }
        @keyframes pulse-slow { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.98); } }
        .sig-wrapper { background: #f1f5f9 !important; border: 3px dashed #f97316 !important; transition: 0.3s; }
        .signature-hint { color: #f97316 !important; flex-direction: column; gap: 8px; }
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700;900&family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap');
        :root { --brand-orange: #f97316; }
        body { font-family: 'Noto Sans TC', sans-serif; background: #0F172A; color: #F1F5F9; min-height: 100vh; overscroll-behavior-y: none; }
        .serif-title { font-family: 'Noto Serif TC', serif; }
        .glass-card { backdrop-filter: blur(25px); background: rgba(30, 41, 59, 0.9); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 2rem; }
        .input-group { display: flex; flex-direction: column; width: 100%; position: relative; }
        .form-input { width: 100%; padding: 1rem 1.2rem; border-radius: 1rem; background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(255, 255, 255, 0.1); color: #FFF; outline: none; transition: 0.3s; font-size: 16px; }
        .form-input:focus { border-color: var(--brand-orange); box-shadow: 0 0 15px rgba(249, 115, 22, 0.2); }
        input[type="time"] { color-scheme: dark; cursor: pointer; }
        .input-valid { border-color: #22c55e !important; }
        .input-invalid { border-color: #ef4444 !important; }
        .error-msg { font-size: 10px; color: #ef4444; height: 14px; margin-top: 4px; padding-left: 8px; opacity: 0; transition: 0.2s; }
        .input-invalid + .error-msg { opacity: 1; }
        .pill-group input { display: none; }
        .pill-item { cursor: pointer; padding: 0.6rem 1rem; border-radius: 999px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); transition: 0.3s; font-size: 0.85rem; color: rgba(255, 255, 255, 0.4); text-align: center; display: inline-flex; align-items: center; justify-content: center; }
        .pill-group input:checked + .pill-item { background: rgba(249, 115, 22, 0.2); border-color: #f97316; color: #f97316; font-weight: bold; }
        #ill_detail_container { max-height: 0; overflow: hidden; transition: 0.5s ease; }
        #ill_detail_container.open { max-height: 200px; margin-top: 1rem; }
        .sig-wrapper { position: relative; background: #FFF; border-radius: 1.5rem; overflow: hidden; border: 2px dashed rgba(249, 115, 22, 0.2); cursor: pointer; }
        .signature-hint { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; pointer-events: none; color: rgba(0,0,0,0.1); font-weight: 900; font-size: 2rem; letter-spacing: 0.2rem; }
        #sig-preview-img { width: 100%; height: 100%; object-fit: contain; display: none; position: relative; z-index: 10; }
        #sig-fullscreen-modal { display: none; position: fixed; inset: 0; background: #ffffff; z-index: 9999; flex-direction: column; }
        .fs-canvas-container { flex: 1; position: relative; background: #f8fafc; overflow: hidden; }
        #fs-canvas { width: 100%; height: 100%; touch-action: none; cursor: crosshair; }
        .fs-hint { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(90deg); color: #e2e8f0; font-size: 4rem; font-weight: 900; pointer-events: none; white-space: nowrap; opacity: 0.5; }
        #adminView, #detailModal, .hidden { display: none; }
        .section-header { font-size: 0.8rem; font-weight: 900; letter-spacing: 0.15em; color: var(--brand-orange); border-left: 4px solid var(--brand-orange); padding-left: 1rem; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 10px; }
        .btn-submit { animation: pulse-orange 2s infinite; }
        @keyframes pulse-orange { 0% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.4); } 70% { box-shadow: 0 0 0 12px rgba(249, 115, 22, 0); } 100% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0); } }
        @media (max-width: 480px) { .section-header { font-size: 0.75rem; } .form-input { padding: 0.8rem 1rem; } }
    </style>
</head>
<body class="antialiased pb-10">

    <nav class="fixed top-0 w-full z-50 px-4 py-4">
        <div class="max-w-5xl mx-auto flex justify-between items-center glass-card px-6 py-3 shadow-2xl border border-white/5">
            <div class="flex items-center gap-2">
                <i class="fas fa-paw text-orange-500"></i>
                <span class="text-sm md:text-lg font-black serif-title text-white tracking-wider">å¯æ¨‚æœå¯µç‰©ç”Ÿæ´»é¤¨|å®šå‹åŒ–å¥‘ç´„ç°½ç½²</span>
            </div>
            <button onclick="checkAdmin()" class="text-[10px] font-bold opacity-30 hover:opacity-100 tracking-widest uppercase text-white">Â© 2026</button>
        </div>
    </nav>

    <main id="clientView" class="pt-24 px-4">
        <div class="max-w-xl mx-auto">
            <div class="glass-card shadow-2xl overflow-hidden border border-white/10">
                <div class="bg-gradient-to-br from-orange-500 to-orange-600 p-8 text-center text-white relative">
                    <h1 class="text-2xl md:text-3xl font-black serif-title tracking-widest relative">å¯µç‰©ç¾å®¹å¥‘ç´„ç°½ç½²</h1>
                    <p class="text-[9px] font-bold mt-2 tracking-[0.4em] uppercase opacity-70 relative">Digital Grooming Record</p>
                </div>

                <div class="p-6 md:p-10 space-y-10">
                    <form id="contract-form" onsubmit="return false;" class="space-y-10">
                        <section>
                            <p class="section-header uppercase">ä¸€ã€ é£¼ä¸»åŸºæœ¬è³‡æ–™</p>
                            <div class="space-y-2">
                                <div class="input-group"><input type="text" id="owner_name" class="form-input" placeholder="é£¼ä¸»å§“å *" required></div>
                                <div class="input-group">
                                    <input type="email" id="email" class="form-input" placeholder="é›»å­ä¿¡ç®±(å¯„é€å¥‘ç´„å‰¯æœ¬ç”¨) *" onblur="validateInput(this, 'email')" required>
                                    <div class="error-msg">è«‹æª¢æŸ¥ä¿¡ç®±æ ¼å¼</div>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="input-group">
                                        <input type="text" id="id_number" class="form-input" placeholder="èº«åˆ†è­‰å­—è™Ÿ *" oninput="this.value = this.value.toUpperCase()" onblur="validateInput(this, 'id')" required>
                                        <div class="error-msg">æ ¼å¼éŒ¯èª¤</div>
                                    </div>
                                    <div class="input-group">
                                        <input type="tel" id="phone" class="form-input num-only" placeholder="è¯çµ¡æ‰‹æ©Ÿ *" onblur="validateInput(this, 'mobile')" required>
                                        <div class="error-msg">æ ¼å¼æ‡‰ç‚º 09xxxxxxxx</div>
                                    </div>
                                </div>
                                <div class="input-group"><input type="text" id="address" class="form-input" placeholder="é€šè¨Šåœ°å€ *" required></div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="input-group"><input type="text" id="emergency_name" class="form-input" placeholder="ç·Šæ€¥è¯çµ¡äºº *" required></div>
                                    <div class="input-group"><input type="tel" id="emergency_tel" class="form-input num-only" placeholder="ç·Šæ€¥é›»è©±" onblur="validateInput(this, 'phone')"><div class="error-msg">æ ¼å¼ä¸ç¬¦</div></div>
                                </div>
                                <input type="text" id="clinic" class="form-input" placeholder="æŒ‡å®šå°±é†«é†«é™¢(è‹¥ç„¡å‰‡é€äº¤ç‰¹ç´„é†«é™¢)">
                            </div>
                        </section>

                        <section>
                            <p class="section-header uppercase">äºŒã€ å¯µç‰©è©³ç´°è³‡æ–™</p>
                            <div class="grid grid-cols-3 gap-2 mb-4">
                                <input type="text" id="pet_name" class="form-input" placeholder="å¯µç‰©åå­— *" required>
                                <input type="text" id="breed" class="form-input" placeholder="å“ç¨®">
                                <input type="text" id="color" class="form-input" placeholder="èŠ±è‰²">
                            </div>

                            <div class="bg-white/5 p-6 rounded-[1.5rem] border border-white/10 space-y-6">
                                <div class="space-y-3 text-white">
                                    <span class="text-[10px] font-bold opacity-40 uppercase px-2">æ™¶ç‰‡è™Ÿç¢¼ *</span>
                                    <div class="input-group">
                                        <input type="tel" id="chip_no" class="form-input !text-orange-500 font-bold" placeholder="è«‹è¼¸å…¥10æˆ–15ç¢¼æ•¸å­—" onblur="validateInput(this, 'chip')">
                                        <div class="error-msg">è«‹è¼¸å…¥æ­£ç¢ºçš„10æˆ–15ç¢¼æ•¸å­—</div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2 pill-group">
                                        <label>
                                            <input type="radio" name="chip_status" id="has_chip_unknown" onchange="toggleChipStatus('unknown')">
                                            <span class="pill-item w-full !py-3">æœ‰æ™¶ç‰‡(è™Ÿç¢¼ä¸è©³)</span>
                                        </label>
                                        <label>
                                            <input type="radio" name="chip_status" id="has_no_chip" onchange="toggleChipStatus('none')">
                                            <span class="pill-item w-full !py-3">ç„¡æ™¶ç‰‡</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between pt-4 border-t border-white/5 pill-group text-white gap-4">
                                    <div class="flex items-center gap-3"><span class="text-[10px] font-bold opacity-40">æ€§åˆ¥</span><label><input type="radio" name="sex" value="å…¬" required><span class="pill-item">å…¬</span></label><label><input type="radio" name="sex" value="æ¯"><span class="pill-item">æ¯</span></label></div>
                                    <div class="flex items-center gap-3"><span class="text-[10px] font-bold opacity-40">çµç´®</span><label><input type="radio" name="fix" value="æ˜¯" required><span class="pill-item">æ˜¯</span></label><label><input type="radio" name="fix" value="å¦"><span class="pill-item">å¦</span></label></div>
                                </div>
                            </div>

                            <div class="mt-6 p-6 bg-white/5 rounded-[2rem] border border-white/5 space-y-4 text-white text-sm">
                                <div class="flex justify-between items-center pill-group"><span>è¦ªäºº</span><div class="flex gap-2"><label><input type="radio" name="p_human" value="æ˜¯" required><span class="pill-item !px-5">æ˜¯</span></label><label><input type="radio" name="p_human" value="å¦"><span class="pill-item !px-5">å¦</span></label></div></div>
                                <div class="flex justify-between items-center pill-group"><span>è¦ªç‹—</span><div class="flex gap-2"><label><input type="radio" name="p_dog" value="æ˜¯" required><span class="pill-item !px-5">æ˜¯</span></label><label><input type="radio" name="p_dog" value="å¦"><span class="pill-item !px-5">å¦</span></label></div></div>
                                <div class="flex justify-between items-center pill-group"><span>å…·æ”»æ“Šæ€§</span><div class="flex gap-2"><label><input type="radio" name="p_atk" value="æ˜¯" required><span class="pill-item !px-5">æ˜¯</span></label><label><input type="radio" name="p_atk" value="å¦"><span class="pill-item !px-5">å¦</span></label></div></div>
                                <div class="border-t border-white/10 pt-4">
                                    <div class="flex justify-between items-center pill-group mb-3"><span class="font-bold text-orange-400">éå¾€ç—…å² *</span><div class="flex gap-2"><label><input type="radio" name="p_ill" value="ç„¡" onchange="toggleIllDetail(false)" required><span class="pill-item px-5">ç„¡</span></label><label><input type="radio" name="p_ill" value="æœ‰" onchange="toggleIllDetail(true)"><span class="pill-item px-5">æœ‰</span></label></div></div>
                                    <div id="ill_detail_container"><textarea id="ill_detail" class="form-input h-24" placeholder="è«‹è©³ç´°èªªæ˜ç—…å²æƒ…æ³"></textarea></div>
                                </div>
                            </div>
                        </section>

                        <section>
                            <p class="section-header uppercase">ä¸‰ã€ æœ¬æ¬¡æœå‹™å…§å®¹</p>
                            <div class="pill-group grid grid-cols-2 md:grid-cols-3 gap-2 mb-6">
                                <label><input type="checkbox" name="service" value="åŒ…æœˆæ´—æ¾¡"><span class="pill-item w-full !py-4">åŒ…æœˆæ´—æ¾¡</span></label>
                                <label><input type="checkbox" name="service" value="åŸºç¤æ´—æ¾¡"><span class="pill-item w-full !py-4">åŸºç¤æ´—æ¾¡</span></label>
                                <label><input type="checkbox" name="service" value="ç²¾ç·»ç¾å®¹"><span class="pill-item w-full !py-4">ç²¾ç·»ç¾å®¹</span></label>
                                <label><input type="checkbox" name="service" value="å±€éƒ¨ä¿®å‰ª"><span class="pill-item w-full !py-4">å±€éƒ¨ä¿®å‰ª</span></label>
                                <label><input type="checkbox" name="service" value="å¯µç‰©å®‰è¦ª"><span class="pill-item w-full !py-4">å¯µç‰©å®‰è¦ª</span></label>
                                <label><input type="checkbox" name="service" value="å…¶ä»–" id="other_trig"><span class="pill-item w-full !py-4 text-center">å…¶ä»–é …ç›®</span></label>
                            </div>
                            <input type="text" id="other_val" class="form-input hidden mb-6" placeholder="è¨»æ˜å…¶ä»–é …ç›®...">

                            <div class="space-y-4">
                                <div class="p-5 bg-white/5 border border-white/10 rounded-2xl flex flex-col gap-2">
                                    <label class="text-[11px] font-bold text-orange-400 uppercase tracking-widest flex items-center gap-2">
                                        <i class="fas fa-clock"></i> é è¨ˆæ¥å›æ™‚é–“
                                    </label>
                                    <input type="time" id="pickup_time" class="form-input !bg-slate-950/80 !border-orange-500/30 text-2xl font-black text-orange-500 py-4">
                                    <p class="text-[10px] text-orange-300 font-bold mt-1 px-1">
                                        <i class="fas fa-info-circle mr-1"></i>é€¾æ™‚ 30 åˆ†é˜ä»¥ä¸Šï¼Œä¾ç…§åƒ¹ç›®è¡¨å…¬å‘Šä¹‹ å®‰è¦ªè²» é¡å¤–æ”¶è²»ã€‚
                                    </p>
                                </div>

                                <div class="p-5 bg-white/5 border border-white/10 rounded-2xl flex flex-col gap-2">
                                    <label class="text-[11px] font-bold text-orange-400 uppercase tracking-widest flex items-center gap-2">
                                        <i class="fas fa-coins"></i> æœ¬æ¬¡æœå‹™é‡‘é¡ *
                                    </label>
                                    <div class="flex items-center gap-3 bg-slate-950/80 border border-orange-500/30 rounded-xl px-4 py-2 focus-within:border-orange-500 transition-all">
                                        <span class="text-orange-500 font-bold text-lg">NT$</span>
                                        <input id="price" type="tel" value="0" onclick="if(this.value=='0')this.value=''" onblur="if(this.value=='')this.value='0'" class="bg-transparent text-3xl font-black text-orange-500 outline-none w-full text-right num-only" required>
                                    </div>
                                    <p class="text-[10px] text-orange-300 font-bold mt-1 px-1">
                                        <i class="fas fa-exclamation-triangle mr-1"></i>æ­¤é‡‘é¡ç‚ºåŸºç¤å ±åƒ¹ï¼Œè‹¥ç¾å ´ç™¼ç¾åš´é‡æ‰“çµã€å¯„ç”ŸèŸ²ç­‰ç‹€æ³ï¼Œå°‡å¦è¡Œå‘ŠçŸ¥åŠ åƒ¹ã€‚
                                    </p>
                                </div>
                            </div>
                        </section>

                        <section>
                            <p class="section-header uppercase">å››ã€ ä¹™æ–¹è³‡è¨Š</p>
                            <div class="bg-white/5 p-6 rounded-[1.5rem] border border-white/10 text-[13px] text-slate-300 space-y-3">
                                <p><b class="text-orange-500">è² è²¬äººï¼š</b>é‚±é§¿ä¾– | <b>é›»è©±ï¼š</b>06-358 2451</p>
                                <p><b class="text-orange-500">åœ°å€ï¼š</b>å°å—å¸‚ä¸­è¥¿å€æ¹–ç¾è¡—70å··16è™Ÿ</p>
                                <p><b class="text-orange-500">ç‡Ÿæ¥­æ™‚é–“ï¼š</b>é€±äºŒè‡³é€±æ—¥ 10:00-19:00 (æ¯é€±ä¸€åº—ä¼‘)</p>
                                <div class="mt-4 pt-4 border-t border-white/10">
                                    <p class="text-[11px] font-bold text-orange-400 uppercase mb-1">ç‰¹ç´„ç·Šæ€¥é€é†«å ´æ‰€</p>
                                    <p>æˆ‘çš„å‹•ç‰©é†«é™¢ (è‡ºå—å¸‚ä¸­è¥¿å€å’Œç·¯è·¯äº”æ®µ235è™Ÿ)</p>
                                </div>
                            </div>
                        </section>

<section class="mb-8">
    <p class="section-header uppercase text-orange-500 font-bold mb-4">äº”ã€ ç°½ç½²è²æ˜èˆ‡æ³•å¾‹ç´„å®š</p>
    <div class="glass-card p-6 border border-white/10 space-y-5">
        <button type="button" onclick="handleToggleLegal()" class="w-full flex justify-between items-center bg-white/5 hover:bg-white/10 p-4 rounded-2xl border border-white/5 transition-all group focus:outline-none">
            <span class="text-sm font-bold text-slate-300">é–±è¦½å®Œæ•´å¯µç‰©ç¾å®¹å®šå‹åŒ–å¥‘ç´„æ¢æ¬¾</span>
            <i id="legal-chevron" class="fas fa-chevron-down text-orange-500 transition-transform duration-300"></i>
        </button>

        <div id="legal-drawer" style="max-height: 0px;" class="overflow-hidden transition-all duration-500 ease-in-out">
            <div class="p-5 bg-black/40 rounded-2xl text-[13px] leading-relaxed text-slate-400 space-y-5 border border-white/5 mb-4 shadow-inner">
                
                <section>
                    <h4 class="text-orange-500 font-bold mb-1">ç¬¬ä¸€æ¢ (å¥‘ç´„ç›®çš„)</h4>
                    <p>æœ¬æœå‹™ç‚ºçŠ¬è²“ç¾å®¹ï¼Œä¸æ¶‰åŠé†«ç™‚è¡Œç‚ºã€‚ä¹™æ–¹ç’°å¢ƒç¶­æŒå®‰å…¨ã€é€šé¢¨ã€æ¸…æ½”ã€‚</p>
                </section>

                <section>
                    <h4 class="text-orange-500 font-bold mb-1">ç¬¬äº”æ¢ (å¥åº·å‘ŠçŸ¥)</h4>
                    <p>ç”²æ–¹æ‡‰èª å¯¦å‘ŠçŸ¥å¯µç‰©ç—…å²èˆ‡æ”»æ“Šæ€§ã€‚è‹¥å› éš±çå°è‡´æ„å¤–ï¼Œä¹™æ–¹ä¸è² æå®³è³ å„Ÿè²¬ä»»ã€‚</p>
                </section>

                <section>
                    <h4 class="text-orange-500 font-bold mb-1">ç¬¬ä¹æ¢ (é€€è²»è¦å®š)</h4>
                    <p>åŒ…æœˆæœå‹™çµ‚æ­¢æ™‚ï¼Œ<span class="text-orange-400 font-bold">é æ”¶ç¸½é¡æ‰£é™¤ã€Œå·²ä½¿ç”¨æ¬¡æ•¸ Ã— å–®æ¬¡åŸåƒ¹ã€</span>å¾Œé€€é‚„é¤˜é¡ï¼Œä¹™æ–¹ä¸é¡å¤–æ”¶å–è§£ç´„æ‰‹çºŒè²»ã€‚</p>
                </section>

                <section>
                    <h4 class="text-orange-500 font-bold mb-1">ç¬¬åäºŒæ¢ (é€¾æ™‚æ¥å›)</h4>
                    <p>æ–¼ç´„å®šæ™‚é–“é€¾æ™‚ 30 åˆ†é˜ä»¥ä¸Šï¼Œä¾ç…§åƒ¹ç›®è¡¨å…¬å‘Šä¹‹ å®‰è¦ªè²» <span class="text-orange-400 font-bold">é¡å¤–æ”¶è²»</span>ã€‚</p>
                </section>

                <section>
                    <h4 class="text-orange-500 font-bold mb-1">ç¬¬åäº”æ¢ (å±¥ç´„ä¿éšœ)</h4>
                    <p>é æ”¶è²»ç”¨ç´¯è¨ˆé‡‘é¡æ–°å°å¹£ä¸€è¬å…ƒä»¥ä¸‹ï¼Œä¾æ³•å…æä¾›å±¥ç´„ä¿éšœã€‚</p>
                </section>

                <p class="text-[10px] opacity-30 text-center pt-2 border-t border-white/5">å…¶é¤˜ç´°ç¯€ä¾è¡Œæ”¿é™¢è¾²å§”æœƒå®šå‹åŒ–å¥‘ç´„ç¯„æœ¬è¾¦ç†</p>
            </div>
        </div>

        <div class="text-[12px] text-slate-500 px-2 space-y-2 border-l-2 border-orange-500/30 ml-1">
            <p>â— ç¶“ç”²ä¹™é›™æ–¹åˆæ„ç´„å®šï¼Œç”±ç”²æ–¹å³æ™‚é–±è¦½ç†è§£æœ¬å¥‘ç´„å…§å®¹ä¸¦ç°½ç½²ã€‚</p>
            <p>â— æœ¬äººå·²ç¢ºèªé è¨ˆæ¥å›æ™‚é–“èˆ‡æœå‹™é‡‘é¡ç„¡èª¤ï¼Œä¸¦åŒæ„ä¸Šè¿°æ¢æ¬¾ã€‚</p>
        </div>

        <label class="flex items-center gap-4 p-4 bg-orange-500/10 rounded-2xl cursor-pointer border border-orange-500/20 hover:bg-orange-500/20 transition-all group">
            <input type="checkbox" id="legal_agree" class="w-6 h-6 rounded-lg accent-orange-500 cursor-pointer" required>
            <span class="text-sm font-black text-white group-hover:text-orange-400">æˆ‘å·²è©³é–±ä¸¦åŒæ„ä»¥ä¸Šå¥‘ç´„æ¢æ¬¾å…§å®¹ *</span>
        </label>
    </div>
</section>

                        <section>
                            <p class="section-header uppercase">å…­ã€ ç”²æ–¹é›»å­ç°½ç½²</p>
                            <div onclick="openFsSig()" class="sig-wrapper h-64 shadow-inner">
                                <div class="signature-hint animate-pulse-slow" id="sig-hint-text">
                                    <i class="fas fa-file-signature text-4xl mb-2"></i>
                                    <span class="text-xl font-black">é»æ“Šæ­¤è™•é–‹å•Ÿç°½å</span>
                                    <p class="text-xs opacity-70 font-normal">Please Click Here to Sign</p>
                                </div>
                                <img id="sig-preview-img" alt="ç°½åé è¦½">
                            </div>
                            <div class="flex justify-end">
                                <button type="button" onclick="clearSig()" class="mt-4 px-6 py-3 bg-red-600/80 hover:bg-red-600 text-white rounded-xl text-sm font-bold uppercase tracking-widest transition-all active:scale-95 flex items-center gap-2 shadow-lg">
                                    <i class="fas fa-eraser"></i> é‡æ–°ç°½ç½² / æ¸…é™¤ç°½å
                                </button>
                            </div>
                            <div class="text-right px-4 mb-4">
    <span class="text-[10px] opacity-50 uppercase tracking-widest">ç°½ç½²æ—¥æœŸï¼š</span>
    <span id="display-today" class="text-sm font-bold text-orange-500"></span>
</div>
                        </section>
                        <button type="button" onclick="handleSave()" id="btn" class="btn-submit w-full bg-orange-500 hover:bg-orange-600 text-white py-8 rounded-[2rem] font-black text-xl shadow-xl transition-all active:scale-[0.98]">ç¢ºèªæäº¤ç´„å®šå–®</button>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <div id="sig-fullscreen-modal">
        <div class="flex justify-between items-center p-4 bg-slate-900 text-white">
            <button onclick="closeFsSig(false)" class="text-sm opacity-70">å–æ¶ˆ</button>
            <span class="text-sm font-bold tracking-widest">é›»å­ç°½ç½²å€åŸŸ</span>
            <button onclick="closeFsSig(true)" class="bg-orange-500 px-6 py-2 rounded-full text-sm font-bold">å®Œæˆ</button>
        </div>
        <div class="fs-canvas-container">
            <div class="fs-hint">è«‹åœ¨æ­¤è™•ç°½å</div>
            <canvas id="fs-canvas"></canvas>
        </div>
        <div class="p-4 bg-slate-100 flex justify-center">
            <button onclick="clearFsCanvas()" class="text-slate-400 text-xs uppercase"><i class="fas fa-redo mr-2"></i>æ¸…é™¤é‡å¯«</button>
        </div>
    </div>

    <main id="adminView" class="pt-28 px-4 pb-20">
        <div class="max-w-6xl mx-auto glass-card overflow-hidden shadow-2xl">
            <div class="p-6 md:p-8 flex flex-col md:flex-row justify-between items-center bg-white/5 border-b border-white/5 text-white gap-4">
                <h3 class="font-black text-xl md:text-2xl text-orange-500 tracking-tighter">æ•¸æ“šç®¡ç†ç³»çµ±</h3>
                <div class="flex flex-col md:flex-row items-center gap-3 w-full md:w-auto">
                    <input type="text" id="adminSearch" oninput="filterRecords(this.value)" placeholder="æœå°‹å¯µç‰©æˆ–é£¼ä¸»..." class="bg-white/5 border border-white/10 rounded-xl px-4 py-3 md:py-2 text-sm outline-none focus:border-orange-500 w-full md:w-64 text-white">
                    <button onclick="logoutAdmin()" class="bg-slate-700 hover:bg-slate-600 text-white px-6 py-3 md:py-2 rounded-xl text-xs font-bold w-full md:w-auto transition-colors">ç™»å‡ºç³»çµ±</button>
                </div>
            </div>
            <div class="overflow-x-auto text-white">
                <table class="w-full text-left min-w-[1000px]">
                    <thead class="bg-white/5 text-[10px] font-bold opacity-40 uppercase">
                        <tr>
                            <th class="px-8 py-6">å¯µç‰© / é£¼ä¸»</th>
                            <th class="px-8 py-6">æœå‹™é …ç›®</th>
                            <th class="px-8 py-6 text-center">é è¨ˆæ¥å›</th>
                            <th class="px-8 py-6 text-center">æœ¬æ¬¡é‡‘é¡</th>
                            <th class="px-8 py-6 text-center">ç°½å</th>
                            <th class="px-8 py-6 text-right">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="adminList" class="divide-y divide-white/5"></tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="detailModal" class="fixed inset-0 bg-slate-900/95 backdrop-blur-3xl z-[120] flex items-center justify-center p-2 md:p-4" onclick="this.style.display='none'">
        <div class="bg-white text-slate-900 w-full max-w-3xl rounded-[2rem] md:rounded-[2.5rem] overflow-hidden shadow-2xl" onclick="event.stopPropagation()">
            <div id="detailContent" class="p-5 md:p-8 overflow-y-auto max-h-[80vh]"></div>
        </div>
    </div>

    <script>

async function fetchHistoryByPhone(phone) {
    if (!/^09\d{8}$/.test(phone)) return; // æ ¼å¼ä¸å°å°±ä¸æŸ¥

    try {
        const { data, error } = await client
            .from('contracts')
            .select('*')
            .eq('phone', phone)
            .order('created_at', { ascending: false })
            .limit(1);

        if (error) throw error;

        if (data && data.length > 0) {
            const history = data[0];
            if (confirm(`æª¢æ¸¬åˆ°æ‚¨çš„æ­·å²ç´€éŒ„ï¼ˆå¯µç‰©ï¼š${history.pet_name}ï¼‰ï¼Œæ˜¯å¦è‡ªå‹•å¸¶å…¥åŸºæœ¬è³‡æ–™ï¼Ÿ`)) {
                autoFillData(history);
            }
        }
    } catch (err) {
        console.error("æŸ¥è©¢æ­·å²ç´€éŒ„å¤±æ•—:", err.message);
    }
}

function autoFillData(i) {
    // å¡«å¯«é£¼ä¸»è³‡æ–™
    document.getElementById('owner_name').value = i.owner_name || '';
    document.getElementById('email').value = i.email || '';
    document.getElementById('id_number').value = i.id_number || '';
    document.getElementById('address').value = i.address || '';
    document.getElementById('emergency_name').value = i.emergency_name || '';
    document.getElementById('emergency_tel').value = i.emergency_tel || '';
    document.getElementById('clinic').value = i.clinic || '';

    // å¡«å¯«å¯µç‰©è³‡æ–™
    document.getElementById('pet_name').value = i.pet_name || '';
    document.getElementById('breed').value = i.breed || '';
    document.getElementById('color').value = i.color || '';
    document.getElementById('chip_no').value = i.chip_no || '';
    
    // è™•ç† Radio Buttons (æ€§åˆ¥ã€çµç´®ã€ç—…å²ç­‰)
    const setRadio = (name, value) => {
        const rb = document.querySelector(`input[name="${name}"][value="${value}"]`);
        if (rb) rb.checked = true;
    };
    
    setRadio('sex', i.sex);
    setRadio('fix', i.fix);
    setRadio('p_human', i.p_human);
    setRadio('p_dog', i.p_dog);
    setRadio('p_atk', i.p_atk);
    setRadio('p_ill', i.p_ill);
    
    if (i.p_ill === 'æœ‰') {
        toggleIllDetail(true);
        document.getElementById('ill_detail').value = i.ill_detail || '';
    }

    // è§¸ç™¼ä¸€æ¬¡æ¬„ä½é©—è­‰é¡è‰²è½‰æ›
    document.querySelectorAll('.form-input').forEach(el => {
        if (el.onblur) el.onblur();
    });
}
        // --- åˆªé™¤åŠŸèƒ½ ---
async function deleteRecord(id, petName) {
    if (!confirm(`ç¢ºå®šè¦åˆªé™¤å¯µç‰©ã€Œ${petName}ã€çš„ç°½ç½²ç´€éŒ„å—ï¼Ÿ\næ­¤å‹•ä½œç„¡æ³•é‚„åŸï¼`)) return;

    try {
        const { error } = await client.from('contracts').delete().eq('id', id);
        if (error) throw error;
        alert("ğŸ—‘ï¸ è³‡æ–™å·²æˆåŠŸåˆªé™¤");
        loadAdmin(); // é‡æ–°æ•´ç†åˆ—è¡¨
    } catch (err) {
        alert("åˆªé™¤å¤±æ•—ï¼š" + err.message);
    }
}

// --- ä¿®æ”¹åŠŸèƒ½ ---
async function editRecord(idx) {
    const i = allRecords[idx];
    const oldPrice = i.price;
    const newPrice = prompt(`ä¿®æ”¹ã€Œ${i.pet_name}ã€çš„æœå‹™é‡‘é¡\nç›®å‰é‡‘é¡ï¼šNT$ ${oldPrice.toLocaleString()}\nè«‹è¼¸å…¥æ–°é‡‘é¡ï¼š`, oldPrice);

    // æª¢æŸ¥ï¼šå–æ¶ˆã€æ²’å¡«ã€æˆ–å¡«å¯«éæ•¸å­—å‰‡ä¸è™•ç†
    if (newPrice === null || newPrice.trim() === "" || isNaN(newPrice)) return;

    const finalPrice = parseInt(newPrice);

    try {
        const { error } = await client
            .from('contracts')
            .update({ price: finalPrice }) // åªæ›´æ–°é‡‘é¡
            .eq('id', i.id); // ç¢ºä¿å°æ‡‰æ­£ç¢ºçš„ ID

        if (error) throw error;
        
        alert(`âœ… é‡‘é¡å·²æˆåŠŸä¿®æ”¹ç‚ºï¼šNT$ ${finalPrice.toLocaleString()}`);
        await loadAdmin(); // é‡æ–°è®€å–è³‡æ–™ï¼Œè®“è¡¨æ ¼é¡¯ç¤ºæœ€æ–°é‡‘é¡
    } catch (err) {
        console.error("Update Error:", err);
        alert("ä¿®æ”¹å¤±æ•—ï¼š" + err.message);
    }
}
        const client = supabase.createClient('https://dkavdfardalijxkqcopi.supabase.co', 'sb_publishable_o7xY-xRVujJP6TFEgEbzIg_4UJlUCVX');
        let canvas, ctx, drawing = false, hasSigned = false, allRecords = [];

        function handleToggleLegal() {
            const drawer = document.getElementById('legal-drawer');
            const chevron = document.getElementById('legal-chevron');
            if (drawer.style.maxHeight === '0px' || !drawer.style.maxHeight) {
                drawer.style.maxHeight = drawer.scrollHeight + "px";
                chevron.style.transform = "rotate(180deg)";
            } else {
                drawer.style.maxHeight = "0px";
                chevron.style.transform = "rotate(0deg)";
            }
        }

        function init() {

            // å°‡ Base64 è½‰ç‚º Blob æª”æ¡ˆæ ¼å¼
function dataURLtoBlob(dataurl) {
    var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
        bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
    while(n--){ u8arr[n] = bstr.charCodeAt(n); }
    return new Blob([u8arr], {type:mime});
}
            // åœ¨ init å‡½å¼ä¸­åŠ å…¥
const today = new Date();
const dateString = `${today.getFullYear()}/${today.getMonth() + 1}/${today.getDate()}`;
document.getElementById('display-today').innerText = dateString;

            // åœ¨ init() å‡½æ•¸å…§åŠ å…¥
const phoneInput = document.getElementById('phone');
phoneInput.addEventListener('blur', function() {
    fetchHistoryByPhone(this.value.trim());
});

            canvas = document.getElementById('fs-canvas');
            ctx = canvas.getContext('2d');
            document.querySelectorAll('.num-only').forEach(el => { el.addEventListener('input', function() { this.value = this.value.replace(/[^0-9]/g, ''); }); });
            document.getElementById('other_trig').onchange = (e) => document.getElementById('other_val').classList.toggle('hidden', !e.target.checked);
            document.getElementById('chip_no').addEventListener('focus', () => {
                document.getElementsByName('chip_status').forEach(r => r.checked = false);
            });
            if (sessionStorage.getItem('isAdmin') === 'true') { showAdminView(); }
        }

        function openFsSig() {
            document.getElementById('sig-fullscreen-modal').style.display = 'flex';
            resizeFsCanvas();
            const getPointerPos = (e) => {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: clientX - rect.left, y: clientY - rect.top };
            };
            const start = (e) => { drawing = true; hasSigned = true; ctx.beginPath(); const p = getPointerPos(e); ctx.moveTo(p.x, p.y); e.preventDefault(); };
            const move = (e) => { if(!drawing) return; const p = getPointerPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); e.preventDefault(); };
            const stop = () => { drawing = false; };
            canvas.onmousedown = start; canvas.onmousemove = move; window.onmouseup = stop;
            canvas.ontouchstart = start; canvas.ontouchmove = move; window.ontouchend = stop;
        }

        function resizeFsCanvas() {
            const ratio = window.devicePixelRatio || 1;
            canvas.width = canvas.parentElement.clientWidth * ratio;
            canvas.height = canvas.parentElement.clientHeight * ratio;
            ctx.scale(ratio, ratio);
            ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.strokeStyle = '#1E293B';
        }

        function clearFsCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); hasSigned = false; }

        function closeFsSig(save) {
            if (save) {
                if (!hasSigned) { alert("è«‹ç°½åå¾Œå†é»é¸å®Œæˆ"); return; }
                const imgData = canvas.toDataURL("image/png");
                document.getElementById('sig-preview-img').src = imgData;
                document.getElementById('sig-preview-img').style.display = 'block';
                document.getElementById('sig-hint-text').style.display = 'none';
            }
            document.getElementById('sig-fullscreen-modal').style.display = 'none';
        }

        function clearSig() {
            document.getElementById('sig-preview-img').src = "";
            document.getElementById('sig-preview-img').style.display = 'none';
            document.getElementById('sig-hint-text').style.display = 'flex';
            hasSigned = false;
        }

        function toggleChipStatus(type) {
            const c = document.getElementById('chip_no');
            if(type === 'none') { c.value = "ç„¡æ™¶ç‰‡"; c.disabled = true; } 
            else if (type === 'unknown') { c.value = "æœ‰æ™¶ç‰‡ï¼ˆè™Ÿç¢¼ä¸è©³ï¼‰"; c.disabled = true; }
            c.classList.remove('input-invalid', 'input-valid');
        }

        document.getElementById('chip_no').addEventListener('click', function() {
            if(this.disabled) { this.disabled = false; this.value = ""; }
        });

        function validateInput(el, type) {
            const val = el.value.trim();
            if (val === "ç„¡æ™¶ç‰‡" || val === "æœ‰æ™¶ç‰‡ï¼ˆè™Ÿç¢¼ä¸è©³ï¼‰") { el.classList.add('input-valid'); return; }
            if (val === "") { el.classList.remove('input-valid', 'input-invalid'); return; }
            let isValid = false;
            switch(type) {
                case 'email': isValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val); break;
                case 'mobile': isValid = /^09\d{8}$/.test(val); break;
                case 'phone': isValid = /^(\d{2,4}-?\d{3,4}-?\d{3,4})|\d{7,10}$/.test(val); break;
                case 'chip': isValid = (val.length === 10 || val.length === 15); break;
                case 'id': isValid = /^[A-Z][12]\d{8}$/.test(val); break;
            }
            el.classList.toggle('input-valid', isValid); el.classList.toggle('input-invalid', !isValid);
        }

        function toggleIllDetail(show) { document.getElementById('ill_detail_container').classList.toggle('open', show); }

async function handleSave() {
    const form = document.getElementById('contract-form');
    const btn = document.getElementById('btn');
    const priceInput = document.getElementById('price');
    const priceVal = parseInt(priceInput.value);
    const signatureCanvas = document.getElementById('fs-canvas');

    // 1. é©—è­‰é‚è¼¯
    if (isNaN(priceVal) || priceVal <= 0) {
        alert("âš ï¸ è«‹è¼¸å…¥æœ‰æ•ˆçš„æœå‹™é‡‘é¡ï¼");
        priceInput.focus();
        return; 
    }
    if (document.querySelectorAll('.input-invalid').length > 0 || !form.checkValidity() || !hasSigned) {
        alert("âš ï¸ è«‹æª¢æŸ¥æ ¼å¼æ˜¯å¦æ­£ç¢ºã€å‹¾é¸åŒæ„ä¸¦å®Œæˆç°½åã€‚");
        return; 
    }

    btn.disabled = true; 
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>æ­£åœ¨è™•ç†ç°½åä¸¦å¯„é€...';

    try {
        // --- 2. ç°½ååœ–ç‰‡è™•ç† ---
        const compressCanvas = document.createElement('canvas');
        const cCtx = compressCanvas.getContext('2d');
        const targetWidth = 500; 
        const scale = targetWidth / signatureCanvas.width;
        compressCanvas.width = targetWidth;
        compressCanvas.height = signatureCanvas.height * scale;
        cCtx.fillStyle = "#FFFFFF";
        cCtx.fillRect(0, 0, compressCanvas.width, compressCanvas.height);
        cCtx.drawImage(signatureCanvas, 0, 0, compressCanvas.width, compressCanvas.height);
        const finalSigData = compressCanvas.toDataURL("image/jpeg", 0.7);

        // --- 3. ä¸Šå‚³ç°½ååˆ° Supabase Storage ---
        const b64Data = finalSigData.split(',')[1];
        const byteCharacters = atob(b64Data);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) { byteNumbers[i] = byteCharacters.charCodeAt(i); }
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], {type: 'image/jpeg'});
        const fileName = `sig_${Date.now()}.jpg`;
        
        await client.storage.from('signatures').upload(fileName, blob, { contentType: 'image/jpeg' });
        const { data: { publicUrl } } = client.storage.from('signatures').getPublicUrl(fileName);

        // --- 4. æº–å‚™åˆç´„æ•¸æ“š ---
        const createdAtTime = new Date().toLocaleString('zh-TW');
        const contractData = {
            owner_name: document.getElementById('owner_name').value.trim(),
            email: document.getElementById('email').value.trim(),
            id_number: document.getElementById('id_number').value.trim().toUpperCase(),
            phone: document.getElementById('phone').value.trim(),
            address: document.getElementById('address').value.trim(),
            emergency_name: document.getElementById('emergency_name').value.trim(),
            emergency_tel: document.getElementById('emergency_tel').value.trim(),
            pet_name: document.getElementById('pet_name').value.trim(),
            breed: document.getElementById('breed').value.trim() || "æœªå¡«å¯«",
            color: document.getElementById('color').value.trim() || "æœªå¡«å¯«",
            chip_no: document.getElementById('chip_no').value.trim(),
            clinic: document.getElementById('clinic').value.trim() || "ç‰¹ç´„é†«é™¢",
            sex: document.querySelector('input[name="sex"]:checked')?.value || "æœªå¡«",
            fix: document.querySelector('input[name="fix"]:checked')?.value || "æœªå¡«",
            p_human: document.querySelector('input[name="p_human"]:checked')?.value || "æœªå¡«",
            p_dog: document.querySelector('input[name="p_dog"]:checked')?.value || "æœªå¡«",
            p_atk: document.querySelector('input[name="p_atk"]:checked')?.value || "æœªå¡«",
            p_ill: document.querySelector('input[name="p_ill"]:checked')?.value || "æœªå¡«",
            ill_detail: document.getElementById('ill_detail').value.trim() || "ç„¡",
            services: Array.from(document.querySelectorAll('input[name="service"]:checked')).map(el => el.value).join(', ') || "æœªå‹¾é¸",
            price: priceVal,
            pickup_time: document.getElementById('pickup_time').value || "å†è¡Œé€šçŸ¥",
            signature_data: publicUrl,
            created_at: new Date().toISOString()
        };

        // --- 5. å­˜å…¥ Supabase Database ---
        const { error: supabaseError } = await client.from('contracts').insert([contractData]);
        if (supabaseError) throw supabaseError;

        // --- 6. å‘¼å« Vercel API ç™¼é€å‰¯æœ¬éƒµä»¶ ---
        const emailHtml = `
            <!DOCTYPE html>
            <html lang="zh-TW">
            <body style="margin: 0; padding: 0; background-color: #f8fafc; font-family: sans-serif;">
                <table width="100%" border="0" cellspacing="0" cellpadding="0" style="background-color: #f8fafc; padding: 20px 0;">
                    <tr>
                        <td align="center">
                            <div style="color: #334155; max-width: 600px; width: 95%; margin: 0 auto; border: 1px solid #e2e8f0; border-radius: 20px; overflow: hidden; background-color: #ffffff; line-height: 1.6;">
                                <div style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); padding: 30px; text-align: center; color: #ffffff;">
                                    <h1 style="margin: 0; font-size: 24px;">å¯æ¨‚æœå¯µç‰©ç”Ÿæ´»é¤¨</h1>
                                    <p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.8;">å¯µç‰©ç¾å®¹å®šå‹åŒ–å¥‘ç´„å‰¯æœ¬</p>
                                </div>
                                <div style="padding: 25px;">
                                    <p>è¦ªæ„›çš„ <strong>${contractData.owner_name}</strong> æ‚¨å¥½ï¼Œä»¥ä¸‹æ˜¯æ‚¨çš„å¥‘ç´„å‰¯æœ¬ï¼š</p>
                                    <p>å¯µç‰©åå­—ï¼š${contractData.pet_name}</p>
                                    <p>æœå‹™é …ç›®ï¼š${contractData.services}</p>
                                    <p>é è¨ˆé‡‘é¡ï¼šNT$ ${priceVal.toLocaleString()}</p>
                                    <p>æ‚¨çš„é›»å­ç°½ç½²æ¨£æœ¬å¦‚ä¸‹ï¼š</p>
                                    <img src="${publicUrl}" width="200" alt="é›»å­ç°½ç« ">
                                    <hr style="border: none; border-top: 1px solid #eee; margin: 20px 0;">
                                    <p style="font-size: 12px; color: #999;">æœ¬éƒµä»¶ç‚ºç³»çµ±è‡ªå‹•ç™¼é€ï¼Œè«‹å‹¿ç›´æ¥å›è¦†ã€‚</p>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            </body>
            </html>`;

        const mailResponse = await fetch('/api/send-email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                email: contractData.email,
                owner_name: contractData.owner_name,
                pet_name: contractData.pet_name,
                htmlContent: emailHtml
            })
        });

        if (!mailResponse.ok) throw new Error('è³‡æ–™å·²å„²å­˜ï¼Œä½†éƒµä»¶å‰¯æœ¬å¯„é€å¤±æ•—');

        alert("âœ¨ ç°½ç½²å®Œæˆï¼Œå·²å°‡å‰¯æœ¬å¯„é€è‡³æ‚¨çš„ä¿¡ç®±ï¼");
        location.reload();

    } catch (err) {
        console.error("æäº¤éŒ¯èª¤:", err);
        alert("æ“ä½œå¤±æ•—: " + (err.message || "æœªçŸ¥éŒ¯èª¤"));
        btn.disabled = false;
        btn.innerHTML = "ç¢ºèªæäº¤ç´„å®šå–®";
    }
}
        function checkAdmin() {
            if (sessionStorage.getItem('isAdmin') === 'true') { showAdminView(); return; }
            const userInput = prompt("ç®¡ç†é‡‘é‘°?");
            if (userInput && btoa(userInput.trim()) === "ODg4OA==") {
                sessionStorage.setItem('isAdmin', 'true'); showAdminView();
            }
        }
        function showAdminView() {
            document.getElementById('clientView').style.display='none'; 
            document.getElementById('adminView').style.display='block'; loadAdmin();
        }
        async function loadAdmin() {
            const { data, error } = await client.from('contracts').select('*').order('created_at', { ascending: false });
            if (data) { allRecords = data; renderAdminList(data); }
        }
function renderAdminList(list) {
    const tbody = document.getElementById('adminList');
    tbody.innerHTML = list.map((i, idx) => {
        // è§£æä¸¦æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“
        const signedTime = i.created_at ? new Date(i.created_at).toLocaleString('zh-TW', {
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        }) : 'ç„¡æ—¥æœŸ';

        return `
        <tr class="hover:bg-white/5 transition-colors">
            <td class="px-8 py-8 font-bold text-sm">
                ${i.pet_name}<br>
                <span class="text-orange-500 text-[10px] opacity-70">${i.owner_name}</span><br>
                <span class="text-slate-500 text-[8px] font-normal ">${signedTime}</span>
            </td>
            <td class="px-8 py-8"><span class="text-xs opacity-60">${i.services}</span></td>
            <td class="px-8 py-8 text-center text-sm font-bold text-blue-400">${i.pickup_time}</td>
            <td class="px-8 py-8 text-center font-black text-orange-500 text-sm">NT$ ${Number(i.price).toLocaleString()}</td>
            <td class="px-8 py-8 text-center">
                <img src="${i.signature_data}" class="h-10 mx-auto bg-white rounded p-1 shadow-sm">
            </td>
            <td class="px-8 py-8 text-right">
                <div class="flex justify-end gap-2">
                    <button onclick="showDetail(${idx})" class="text-orange-500 font-bold border border-orange-500/30 px-3 py-2 rounded-lg text-[10px] hover:bg-orange-500/10 transition-all">è©³æƒ…</button>
                    <button onclick="editRecord(${idx})" class="text-blue-400 font-bold border border-blue-400/30 px-3 py-2 rounded-lg text-[10px] hover:bg-blue-400/10 transition-all">æ”¹é‡‘é¡</button>
                    <button onclick="deleteRecord('${i.id}', '${i.pet_name}')" class="text-red-400 font-bold border border-red-400/30 px-3 py-2 rounded-lg text-[10px] hover:bg-red-400/10 transition-all">åˆªé™¤</button>
                </div>
            </td>
        </tr>`;
    }).join('');
}
        function logoutAdmin() { sessionStorage.removeItem('isAdmin'); location.reload(); }
        function filterRecords(val) {
            const s = val.toLowerCase();
            const f = allRecords.filter(i => i.pet_name.toLowerCase().includes(s) || i.owner_name.toLowerCase().includes(s));
            renderAdminList(f);
        }
function showDetail(idx) {
    const i = allRecords[idx];
    
    // 1. æ ¼å¼åŒ–ç°½ç½²æ—¥æœŸèˆ‡æ™‚é–“ (åŒ…å« å¹´/æœˆ/æ—¥ æ™‚:åˆ†:ç§’)
    const fullTime = i.created_at ? new Date(i.created_at).toLocaleString('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    }) : 'ç„¡è¨˜éŒ„';

    document.getElementById('detailContent').innerHTML = `
        <div class="space-y-6 text-sm text-slate-800 pb-10">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center bg-slate-100 p-4 rounded-2xl border border-slate-200 gap-2">
                <div>
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest block">ç³»çµ±ç´€éŒ„ç·¨è™Ÿ</span>
                    <span class="text-xs font-mono text-slate-600">ID: ${i.id}</span>
                </div>
                <div class="text-left sm:text-right">
                    <span class="text-[10px] font-bold text-orange-400 uppercase tracking-widest block">æ•¸ä½ç°½ç½²å®Œæˆæ™‚é–“</span>
                    <span class="text-sm font-black text-slate-700"><i class="far fa-calendar-check mr-1 text-orange-500"></i> ${fullTime}</span>
                </div>
            </div>

            <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                <p class="text-orange-600 font-black border-b border-orange-100 pb-2 mb-4 uppercase text-xs tracking-widest">ä¸€ã€ é£¼ä¸»å®Œæ•´è³‡æ–™</p>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-y-3 gap-x-4">
                    <p><b>é£¼ä¸»å§“åï¼š</b> ${i.owner_name}</p><p><b>èº«åˆ†è­‰è™Ÿï¼š</b> ${i.id_number}</p>
                    <p><b>è¯çµ¡æ‰‹æ©Ÿï¼š</b> ${i.phone}</p><p><b>é›»å­éƒµä»¶ï¼š</b> ${i.email}</p>
                    <p class="sm:col-span-2"><b>é€šè¨Šåœ°å€ï¼š</b> ${i.address}</p>
                    <p><b>ç·Šæ€¥è¯çµ¡äººï¼š</b> ${i.emergency_name}</p><p><b>ç·Šæ€¥é›»è©±ï¼š</b> ${i.emergency_tel || 'æœªå¡«å¯«'}</p>
                    <p class="sm:col-span-2"><b>æŒ‡å®šå°±é†«ï¼š</b> ${i.clinic || 'ç„¡'}</p>
                </div>
            </div>
            
            <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                <p class="text-orange-600 font-black border-b border-orange-100 pb-2 mb-4 uppercase text-xs tracking-widest">äºŒã€ å¯µç‰©å®Œæ•´è³‡æ–™</p>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-y-3 gap-x-4">
                    <p><b>å¯µç‰©åå­—ï¼š</b> ${i.pet_name}</p><p><b>å“ç¨®èŠ±è‰²ï¼š</b> ${i.breed} / ${i.color}</p>
                    <p><b>æ€§åˆ¥ï¼š</b> ${i.sex}</p><p><b>çµç´®ï¼š</b> ${i.fix}</p>
                    <p class="sm:col-span-2"><b>æ™¶ç‰‡è™Ÿç¢¼ï¼š</b> ${i.chip_no}</p>
                    <p class="sm:col-span-2"><b>æ€§æ ¼ç‰¹å¾µï¼š</b> è¦ªäºº(${i.p_human}) Â· è¦ªç‹—(${i.p_dog}) Â· å…·æ”»æ“Šæ€§(${i.p_atk})</p>
                    <p class="sm:col-span-2"><b>éå¾€ç—…å²ï¼š</b> ${i.p_ill === 'æœ‰' ? `<span class="text-red-500 font-bold">${i.ill_detail}</span>` : 'ç„¡'}</p>
                </div>
            </div>

            <div class="bg-orange-50 p-6 rounded-2xl border border-orange-100">
                <p class="text-orange-600 font-black border-b border-orange-200 pb-2 mb-4 uppercase text-xs tracking-widest">ä¸‰ã€ æœ¬æ¬¡æœå‹™ç´„å®š</p>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-y-3 gap-x-4">
                    <p class="sm:col-span-2"><b>æœå‹™é …ç›®ï¼š</b> <span class="text-orange-700 font-bold">${i.services}</span></p>
                    <p><b>é è¨ˆæ¥å›ï¼š</b> <span class="text-blue-600 font-bold">${i.pickup_time}</span></p>
                    <p><b>æœ¬æ¬¡è²»ç”¨ï¼š</b> <span class="text-orange-600 font-black">NT$ ${Number(i.price).toLocaleString()}</span></p>
                </div>
            </div>

            <div class="text-center p-6 border-2 border-dashed border-slate-200 rounded-2xl bg-white">
                <p class="text-[10px] text-slate-400 mb-2 uppercase tracking-widest">ç”²æ–¹ç°½ç½²æ¨£æœ¬</p>
                <img src="${i.signature_data}" class="max-h-48 mx-auto" alt="é¡§å®¢ç°½å">
                <p class="text-[9px] text-slate-400 mt-2 italic">æ­¤é›»å­ç°½åæ–¼ç³»çµ±æ™‚é–“ ${fullTime} ç´€éŒ„å­˜æª”</p>
            </div>
        </div>`;
    document.getElementById('detailModal').style.display = 'flex';
}
        window.onload = init;
    </script>
</body>
</html>
